name: Verificar Contribui√ß√µes Copilot

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write

jobs:
  verify-copilot-contributions:
    name: Verificar Contribui√ß√µes do Copilot
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Verificar contribui√ß√µes do Copilot
      id: verify
      run: |
        echo "## ü§ñ Verifica√ß√£o de Contribui√ß√µes do Copilot" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Verificar se h√° commits do Copilot neste PR
        COPILOT_COMMITS=$(git log origin/develop..HEAD --author="copilot" --oneline)
        
        if [ -z "$COPILOT_COMMITS" ]; then
          echo "‚úÖ Nenhuma contribui√ß√£o do Copilot detectada neste PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Todas as mudan√ßas foram feitas pela equipe." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è Contribui√ß√µes do Copilot detectadas:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$COPILOT_COMMITS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù A√ß√£o Necess√°ria" >> $GITHUB_STEP_SUMMARY
          echo "Por favor, atualize o arquivo \`COPILOT_INSTRUCTIONS.md\` para documentar essas contribui√ß√µes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Listar arquivos modificados pelos commits do Copilot
          echo "### üìÇ Arquivos Modificados pelo Copilot" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log origin/develop..HEAD --author="copilot" --name-only --pretty=format: | sort -u | grep -v '^$' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Esta verifica√ß√£o garante que o COPILOT_INSTRUCTIONS.md reflita com precis√£o as contribui√ß√µes do GitHub Copilot.*" >> $GITHUB_STEP_SUMMARY
    
    - name: Verificar se COPILOT_INSTRUCTIONS.md foi atualizado
      if: success()
      run: |
        # Verificar se h√° commits do Copilot
        COPILOT_COMMITS=$(git log origin/develop..HEAD --author="copilot" --oneline)
        
        if [ ! -z "$COPILOT_COMMITS" ]; then
          # Verificar se COPILOT_INSTRUCTIONS.md foi modificado neste PR
          INSTRUCTIONS_MODIFIED=$(git diff origin/develop..HEAD --name-only | grep "COPILOT_INSTRUCTIONS.md" || true)
          
          if [ -z "$INSTRUCTIONS_MODIFIED" ]; then
            echo "‚ö†Ô∏è AVISO: Contribui√ß√µes do Copilot detectadas, mas COPILOT_INSTRUCTIONS.md n√£o foi atualizado."
            echo "Por favor, atualize o arquivo COPILOT_INSTRUCTIONS.md para documentar as novas contribui√ß√µes."
            exit 0  # N√£o falhar o workflow, apenas avisar
          else
            echo "‚úÖ COPILOT_INSTRUCTIONS.md foi atualizado neste PR."
          fi
        fi
    
    - name: Coment√°rio no PR (se necess√°rio)
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          
          try {
            const copilotCommits = execSync('git log origin/develop..HEAD --author="copilot" --oneline', { encoding: 'utf-8' });
            
            if (copilotCommits.trim()) {
              const instructionsModified = execSync('git diff origin/develop..HEAD --name-only | grep "COPILOT_INSTRUCTIONS.md" || true', { encoding: 'utf-8' });
              
              if (!instructionsModified.trim()) {
                const comment = `## ü§ñ Verifica√ß√£o de Contribui√ß√µes do Copilot\n\n` +
                  `‚ö†Ô∏è Este PR cont√©m contribui√ß√µes do GitHub Copilot, mas o arquivo \`COPILOT_INSTRUCTIONS.md\` n√£o foi atualizado.\n\n` +
                  `### Commits do Copilot detectados:\n\`\`\`\n${copilotCommits}\`\`\`\n\n` +
                  `**A√ß√£o recomendada:** Por favor, atualize o \`COPILOT_INSTRUCTIONS.md\` para documentar essas contribui√ß√µes com precis√£o.`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
            }
          } catch (error) {
            console.log('Erro ao verificar commits do Copilot:', error.message);
          }
